# Rule Writing & Reporting

### YARA

> YARA is a powerful, open-source, detection and threat hunting tool which takes a rule file and a suspect file, and then searches the suspect file for any things that match a rule in the rule file. It is a pattern-matching engine that is used to match IOCs in malware with an unknown sample to determine if it is a known malware sample. YARA rules are relatively easy to write, whilst the tool itself is very powerful.

YARA rule format example:
```yara
rule YARA_Example {
	meta:
		last_update: "2021-10-15"
		author: "PMAT"
		description: "A sample YARA rule for PMAT"

	strings:
		// fill out identfying strings and other criteria
		...
		
	condition:
		// fill out condition that must be met to identify the binary 
		...
		
}
```

Process:
- you perform malware analysis on a sample and deduce IOCs which can be used to identify this malware sample in the future 
- you then transform these IOCs into YARA rules inside a YARA rule file 
- you upload this YARA rule file to a detection/protection solution which uses the rules in the file and the YARA engine to identify if a file is the malware sample you analysed, hence it can then protect against it


Example of YARA rule:
```yara
rule YARA_Example {
	meta:
		last_update: "2021-10-15"
		author: "PMAT"
		description: "A sample YARA rule for PMAT"

	strings:
		$string1 = "YOURTHAMANNOWDOG" ascii
		$string2 = "nim"
		$PE_mage_byte = "MZ"
		$sus_hex_string = { FF E4 ?? 00 FF }

	condition:
		$PE_magic_byte at 0 and
		($string1 and $string2) or 
		$sus_hex_string

}
```
- searches for the strings "YOURTHEMANNOWDOW", "nim"
- searches for the first "MZ" bytes in a file (determines if the file format is a PE file) -- matches `at` position `0` (first hex bytes)
- searches for suspicious hex bytes "FF EF ?? 00 FF" (uses regex) which indicates something bad is happening in the binary


Usage with **yara32**:
- once you have a YARA rule written, you can test it if works using the `yara32` utility on FLARE VM
- by default the utility will list all files that match the given rule 
- with a single malware file: `yara32 <yara_rule>.yara <malware_binary>`
	- use `-w` to suppress warnings, `-p` to specify the threa
	- i.e. `yara32 my-rule.yara malware.exe -w -p 32`
	- use `-s` to output what detection criteria was detected in the binary
	- i.e. `yara32 my-rule.yara malware.exe -s -w -p 32`
- with a directory: `yara32 <yara_rule>.yara <directory>`
	- i.e. with the current directory: `yara32 my-rule.yara . -w -p 32`
- recursively through directories: `yara <yara_rule>.yara -r <starting_directory>`
	- i.e. everything in `C:\Users` directory: `yara32 my-rule.yara -r C:\Users -w -p 32`
- ideally you will be able to fine tune your rules enough to recursively search through file systems and identify malware

--- 

### Report Writing

> Report writing is probably the most import part of malware analysis as you others must be able to digest what you have learned to then make actions, and these others may not necessarily be technical people.

- a template of a malware analysis report can be found at https://github.com/HuskyHacks/PMAT-labs/tree/main/labs/5-3.ReportWriting
- report should be captivating, but also respects the time of the person reading:
- start with an Executive Summary that is high level and includes highlights (big moving parts)
- then goto a high-level technical summary with pictures and diagrams to make technical IOCs easy to digest
- make sure to sanitise IOCs (i.e. links to domains, IP addresses, etc.)
- next, get into the deep technical analysis using the notes you took when performing each stage of analysis, including screenshots, code snippets, etc.
- from here summarise the IOCs so that the people who need to use them can easily identify them, these can be split into host-based and network-based IOCs
- conclude with YARA rules to detect the malware